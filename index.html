<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>è”šæ¥å¯æœŸ - å¢å¼ºå…¼å®¹ç‰ˆ</title>
    
    <!-- é€šç”¨metaæ ‡ç­¾ï¼Œç¡®ä¿æœ€å¤§å…¼å®¹æ€§ -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no, email=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ä¸‰æ˜Ÿ/å®‰å“ä¸“ç”¨meta -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="è”šæ¥å¯æœŸ">
    <meta name="theme-color" content="#000000">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- ç¼“å­˜æ§åˆ¶ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        /* é‡ç½®å’ŒåŸºç¡€æ ·å¼ - ç¡®ä¿è·¨è®¾å¤‡ä¸€è‡´æ€§ */
        * {
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            font-family: 
                -apple-system, 
                BlinkMacSystemFont, 
                "Segoe UI", 
                Roboto, 
                "Helvetica Neue", 
                Arial, 
                "Noto Sans", 
                sans-serif,
                "Apple Color Emoji", 
                "Segoe UI Emoji", 
                "Segoe UI Symbol", 
                "Noto Color Emoji";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ä¸‰æ˜Ÿè®¾å¤‡ç‰¹æ®Šä¼˜åŒ– */
        @media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
            body {
                -ms-content-zooming: none;
            }
        }
        
        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: #000;
        }
        
        /* åŠ è½½åŠ¨ç”» - ç®€å•å…¼å®¹ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ffffff;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            min-width: 200px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å›¾ç‰‡å®¹å™¨ */
        .image-container {
            width: 100%;
            height: 100%;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            background: #000;
        }
        
        #image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }
        
        /* é”™è¯¯é¢æ¿ */
        .error-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 340px;
            border: 1px solid #333;
            display: none;
            z-index: 2000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .error-icon {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }
        
        .error-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .error-message {
            font-size: 15px;
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.5;
            text-align: left;
        }
        
        /* æŒ‰é’®æ ·å¼ - ç¡®ä¿ç‚¹å‡»åŒºåŸŸè¶³å¤Ÿå¤§ */
        .btn {
            display: block;
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            text-decoration: none;
            text-align: center;
        }
        
        .retry-btn {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        
        .retry-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }
        
        .link-btn {
            background: transparent;
            color: #007AFF;
            border: 2px solid #007AFF;
        }
        
        .link-btn:active {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .network-tips {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 13px;
            color: #999;
            text-align: left;
            line-height: 1.6;
        }
        
        .network-tips strong {
            color: #fff;
            display: block;
            margin-bottom: 5px;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #00C6FF);
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        /* è°ƒè¯•ä¿¡æ¯ */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            font-size: 11px;
            font-family: monospace;
            padding: 8px;
            border-radius: 4px;
            z-index: 10000;
            display: none;
        }
        
        /* ç¦»çº¿æŒ‡ç¤ºå™¨ */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #FF3B30;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 10000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <!-- ç¦»çº¿æŒ‡ç¤ºå™¨ -->
    <div class="offline-indicator" id="offlineIndicator">ç¦»çº¿</div>
    
    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <div class="debug-info" id="debugInfo"></div>
    
    <div id="app">
        <!-- åŠ è½½ç•Œé¢ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div style="margin-bottom: 5px; font-size: 16px;">æ­£åœ¨è¿æ¥æœåŠ¡å™¨</div>
            <div style="font-size: 13px; color: #aaa;" id="status">åˆå§‹åŒ–...</div>
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        
        <!-- å›¾ç‰‡å®¹å™¨ -->
        <div class="image-container" id="imageContainer">
            <img id="image" alt="è”šæ¥å¯æœŸé©¬å¹´çª—è´´" crossorigin="anonymous">
        </div>
        
        <!-- é”™è¯¯é¢æ¿ -->
        <div class="error-panel" id="errorPanel">
            <span class="error-icon">âš ï¸</span>
            <div class="error-title" id="errorTitle">ç½‘ç»œè¿æ¥å¤±è´¥</div>
            <div class="error-message" id="errorMsg">
                æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®åé‡è¯•
            </div>
            
            <button class="btn retry-btn" id="retryBtn">é‡æ–°è¿æ¥</button>
            <button class="btn link-btn" id="linkBtn">å¤‡ç”¨è®¿é—®æ–¹å¼</button>
            
            <div class="network-tips">
                <strong>å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼š</strong>
                1. æ£€æŸ¥WiFi/ç§»åŠ¨æ•°æ®æ˜¯å¦å¼€å¯<br>
                2. å…³é—­VPNæˆ–ä»£ç†è½¯ä»¶<br>
                3. é‡å¯æ‰‹æœºæˆ–é£è¡Œæ¨¡å¼åˆ‡æ¢<br>
                4. ä½¿ç”¨å¤‡ç”¨è®¿é—®æ–¹å¼
            </div>
        </div>
    </div>

    <script>
        // ==================== å¢å¼ºå…¼å®¹æ€§é…ç½® ====================
        const CONFIG = {
            // å¤šæºå›¾ç‰‡è·¯å¾„ - å¢åŠ å†…ç½‘å…¼å®¹æº
            imageSources: [
                // 1. jsDelivr CDNï¼ˆæœ€ç¨³å®šï¼Œæ¨èï¼‰
                {
                    name: 'jsDelivr CDN',
                    baseUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/',
                    testUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/é©¬å¹´çª—è´´-02.jpg'
                },
                // 2. ç›´æ¥GitHub Pagesï¼ˆå¤‡ç”¨ï¼‰
                {
                    name: 'GitHubä¸»æº',
                    baseUrl: 'https://cfelix888.github.io/chunjie/images/',
                    testUrl: 'https://cfelix888.github.io/chunjie/images/é©¬å¹´çª—è´´-02.jpg'
                },
                // 3. Raw GitHubï¼ˆç¬¬äºŒå¤‡ç”¨ï¼‰
                {
                    name: 'GitHub Raw',
                    baseUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/',
                    testUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/é©¬å¹´çª—è´´-02.jpg'
                },
                // 4. ç›´æ¥IPè®¿é—®ï¼ˆæç«¯æƒ…å†µï¼‰
                {
                    name: 'å¤‡ç”¨IPæº',
                    baseUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/',
                    testUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/é©¬å¹´çª—è´´-02.jpg'
                }
            ],
            
            // å›¾ç‰‡åˆ—è¡¨
            images: [
                "é©¬å¹´çª—è´´-02.jpg",
                "é©¬å¹´çª—è´´-03.jpg",
                "é©¬å¹´çª—è´´-04.jpg",
                "é©¬å¹´çª—è´´-05.jpg",
                "é©¬å¹´çª—è´´-06.jpg",
                "é©¬å¹´çª—è´´-07.jpg",
                "é©¬å¹´çª—è´´-08.jpg",
                "é©¬å¹´çª—è´´-09.jpg",
                "é©¬å¹´çª—è´´-10.jpg",
                "é©¬å¹´çª—è´´-11.jpg"
            ],
            
            // å­˜å‚¨é”®å
            storageKeys: {
                deviceId: 'ne_enhanced_device_id',
                imageIndex: 'ne_enhanced_image_idx',
                preferredSource: 'ne_enhanced_preferred_source',
                fallbackMode: 'ne_fallback_mode'
            },
            
            // è¶…æ—¶è®¾ç½®
            timeouts: {
                connectionTest: 6000, // è¿æ¥æµ‹è¯•6ç§’
                imageLoad: 15000,     // å›¾ç‰‡åŠ è½½15ç§’
                retryDelay: 2000      // é‡è¯•å»¶è¿Ÿ2ç§’
            },
            
            // é‡è¯•ç­–ç•¥
            retryStrategy: {
                maxRetries: 5,
                backoffMultiplier: 1.5
            }
        };
        
        // ==================== è®¾å¤‡æ£€æµ‹ ====================
        const DeviceInfo = {
            // æ£€æµ‹è®¾å¤‡ç±»å‹
            detect: function() {
                const ua = navigator.userAgent;
                return {
                    isSamsung: /samsung/i.test(ua) || /SM-/i.test(ua),
                    isIOS: /iPad|iPhone|iPod/.test(ua),
                    isAndroid: /Android/.test(ua),
                    isWechat: /MicroMessenger/i.test(ua),
                    isQQ: /QQ\//i.test(ua),
                    isUC: /UCBrowser/i.test(ua),
                    isSafari: /^((?!chrome|android).)*safari/i.test(ua),
                    isChrome: /Chrome/.test(ua) && !/Edg/.test(ua),
                    browser: this.getBrowserName(ua),
                    os: this.getOS(ua)
                };
            },
            
            getBrowserName: function(ua) {
                if (/MSIE|Trident/.test(ua)) return 'IE';
                if (/Edg/.test(ua)) return 'Edge';
                if (/Chrome/.test(ua)) return 'Chrome';
                if (/Firefox/.test(ua)) return 'Firefox';
                if (/Safari/.test(ua)) return 'Safari';
                return 'Unknown';
            },
            
            getOS: function(ua) {
                if (/Android/.test(ua)) return 'Android';
                if (/iPad|iPhone|iPod/.test(ua)) return 'iOS';
                if (/Windows/.test(ua)) return 'Windows';
                if (/Mac OS/.test(ua)) return 'MacOS';
                if (/Linux/.test(ua)) return 'Linux';
                return 'Unknown';
            }
        };
        
        // ==================== å·¥å…·å‡½æ•° ====================
        const Utils = {
            updateStatus: function(text) {
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = text;
                }
                console.log('çŠ¶æ€:', text);
                
                // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                this.updateDebugInfo('status', text);
            },
            
            updateProgress: function(percent) {
                const progress = document.getElementById('progress');
                const progressBar = document.getElementById('progressBar');
                if (progress && progressBar) {
                    progress.style.width = percent + '%';
                    progressBar.style.display = percent > 0 ? 'block' : 'none';
                }
            },
            
            updateDebugInfo: function(key, value) {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    const current = debugInfo.innerHTML;
                    const lines = current.split('<br>').filter(l => !l.startsWith(key + ':'));
                    lines.push(`${key}: ${value}`);
                    debugInfo.innerHTML = lines.slice(-5).join('<br>');
                }
            },
            
            showError: function(title, message) {
                const loading = document.getElementById('loading');
                const errorPanel = document.getElementById('errorPanel');
                const errorTitle = document.getElementById('errorTitle');
                const errorMsg = document.getElementById('errorMsg');
                
                if (loading) loading.style.display = 'none';
                if (errorTitle) errorTitle.textContent = title;
                if (errorMsg) errorMsg.innerHTML = message;
                if (errorPanel) errorPanel.style.display = 'block';
                
                // éšè—å›¾ç‰‡
                document.getElementById('imageContainer').style.display = 'none';
                
                this.updateDebugInfo('error', title);
            },
            
            showLoading: function() {
                const loading = document.getElementById('loading');
                const errorPanel = document.getElementById('errorPanel');
                
                if (loading) loading.style.display = 'block';
                if (errorPanel) errorPanel.style.display = 'none';
                if (this.imageContainer) this.imageContainer.style.display = 'none';
            },
            
            showImage: function() {
                const loading = document.getElementById('loading');
                const imageContainer = document.getElementById('imageContainer');
                
                if (loading) loading.style.display = 'none';
                if (imageContainer) {
                    imageContainer.style.display = 'block';
                    // å¼ºåˆ¶é‡ç»˜ï¼Œè§£å†³æŸäº›è®¾å¤‡æ˜¾ç¤ºé—®é¢˜
                    imageContainer.offsetHeight;
                }
            },
            
            setOfflineIndicator: function(isOffline) {
                const indicator = document.getElementById('offlineIndicator');
                if (indicator) {
                    indicator.style.display = isOffline ? 'block' : 'none';
                }
            }
        };
        
        // ==================== ç½‘ç»œç®¡ç†å™¨ ====================
        const NetworkManager = {
            currentSource: null,
            fallbackMode: false,
            deviceInfo: DeviceInfo.detect(),
            
            // æµ‹è¯•è¿æ¥ - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿å…¼å®¹æ€§
            testConnection: function(url) {
                return new Promise((resolve) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        resolve({ success: false, error: 'timeout' });
                    }, CONFIG.timeouts.connectionTest);
                    
                    const startTime = Date.now();
                    
                    // æ–¹æ³•1: å°è¯•fetch
                    fetch(url + '?t=' + Date.now(), {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        signal: controller.signal,
                        headers: {
                            'Accept': '*/*',
                            'Cache-Control': 'no-cache'
                        }
                    })
                    .then(() => {
                        clearTimeout(timeoutId);
                        const latency = Date.now() - startTime;
                        resolve({ success: true, latency });
                    })
                    .catch(() => {
                        // æ–¹æ³•2: å°è¯•XMLHttpRequestï¼ˆæ—§è®¾å¤‡å…¼å®¹ï¼‰
                        this.testWithXHR(url, startTime, timeoutId, resolve);
                    });
                });
            },
            
            testWithXHR: function(url, startTime, timeoutId, resolve) {
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = CONFIG.timeouts.connectionTest;
                    
                    xhr.onload = function() {
                        clearTimeout(timeoutId);
                        const latency = Date.now() - startTime;
                        resolve({ success: true, latency });
                    };
                    
                    xhr.onerror = xhr.ontimeout = function() {
                        // æ–¹æ³•3: ä½¿ç”¨Imageå¯¹è±¡ï¼ˆæœ€ç»ˆå°è¯•ï¼‰
                        clearTimeout(timeoutId);
                        NetworkManager.testWithImage(url, startTime, resolve);
                    };
                    
                    xhr.open('GET', url + '?t=' + Date.now(), true);
                    xhr.send();
                } catch (e) {
                    NetworkManager.testWithImage(url, startTime, resolve);
                }
            },
            
            testWithImage: function(url, startTime, resolve) {
                const img = new Image();
                const testTimeout = setTimeout(() => {
                    resolve({ success: false, error: 'image_timeout' });
                }, CONFIG.timeouts.connectionTest);
                
                img.onload = function() {
                    clearTimeout(testTimeout);
                    const latency = Date.now() - startTime;
                    resolve({ success: true, latency });
                };
                
                img.onerror = function() {
                    clearTimeout(testTimeout);
                    resolve({ success: false, error: 'image_error' });
                };
                
                // ä¸‰æ˜Ÿè®¾å¤‡å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
                if (this.deviceInfo.isSamsung) {
                    img.crossOrigin = 'anonymous';
                }
                
                img.src = url + '?test=' + Date.now();
            },
            
            // æŸ¥æ‰¾æœ€ä½³å›¾ç‰‡æº
            findBestSource: async function() {
                Utils.updateStatus('æµ‹è¯•ç½‘ç»œè¿æ¥...');
                Utils.updateProgress(10);
                
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„é¦–é€‰æº
                const preferred = localStorage.getItem(CONFIG.storageKeys.preferredSource);
                if (preferred) {
                    const source = CONFIG.imageSources.find(s => s.name === preferred);
                    if (source) {
                        Utils.updateStatus(`æµ‹è¯• ${source.name}...`);
                        const result = await this.testConnection(source.testUrl);
                        if (result.success) {
                            Utils.updateStatus(`âœ… ä½¿ç”¨å­˜å‚¨çš„æº: ${source.name}`);
                            Utils.updateDebugInfo('source', source.name);
                            return source;
                        }
                    }
                }
                
                // å¹¶è¡Œæµ‹è¯•æ‰€æœ‰æºä»¥æé«˜é€Ÿåº¦
                Utils.updateProgress(30);
                const testPromises = CONFIG.imageSources.map(async (source, index) => {
                    Utils.updateStatus(`æµ‹è¯•æº ${index + 1}/${CONFIG.imageSources.length}...`);
                    try {
                        const result = await this.testConnection(source.testUrl);
                        return { source, result };
                    } catch (e) {
                        return { source, result: { success: false, error: e.message } };
                    }
                });
                
                const results = await Promise.allSettled(testPromises);
                Utils.updateProgress(70);
                
                // æ‰¾å‡ºæœ€å¿«çš„å¯ç”¨æº
                const availableSources = [];
                for (const promiseResult of results) {
                    if (promiseResult.status === 'fulfilled') {
                        const { source, result } = promiseResult.value;
                        if (result.success) {
                            availableSources.push({ source, latency: result.latency || 9999 });
                        }
                    }
                }
                
                if (availableSources.length > 0) {
                    // æŒ‰å»¶è¿Ÿæ’åºï¼Œé€‰æ‹©æœ€å¿«çš„
                    availableSources.sort((a, b) => a.latency - b.latency);
                    const bestSource = availableSources[0].source;
                    
                    // å­˜å‚¨é¦–é€‰æº
                    localStorage.setItem(CONFIG.storageKeys.preferredSource, bestSource.name);
                    Utils.updateStatus(`âœ… ä½¿ç”¨æœ€ä½³æº: ${bestSource.name}`);
                    Utils.updateDebugInfo('source', bestSource.name);
                    
                    return bestSource;
                }
                
                return null;
            },
            
            // åŠ è½½å›¾ç‰‡
            loadImage: async function(imageName, source, retryCount = 0) {
                const maxRetries = CONFIG.retryStrategy.maxRetries;
                
                if (retryCount >= maxRetries) {
                    throw new Error(`å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå·²é‡è¯• ${maxRetries} æ¬¡`);
                }
                
                Utils.updateStatus(`åŠ è½½å›¾ç‰‡ä¸­... (${retryCount + 1}/${maxRetries})`);
                Utils.updateProgress(50 + (retryCount * 10));
                
                try {
                    const imgUrl = source.baseUrl + encodeURIComponent(imageName) + 
                                  '?v=' + Date.now() + '&retry=' + retryCount + 
                                  '&device=' + (this.deviceInfo.isSamsung ? 'samsung' : 'other');
                    
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        let loaded = false;
                        
                        // è¶…æ—¶æ§åˆ¶
                        const timeout = setTimeout(() => {
                            if (!loaded) {
                                img.onload = img.onerror = null;
                                reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶'));
                            }
                        }, CONFIG.timeouts.imageLoad);
                        
                        img.onload = function() {
                            loaded = true;
                            clearTimeout(timeout);
                            
                            // éªŒè¯å›¾ç‰‡æ˜¯å¦æœ‰æ•ˆ
                            if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
                                // ä¸‰æ˜Ÿè®¾å¤‡å›¾ç‰‡åŠ è½½åå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
                                if (DeviceInfo.detect().isSamsung) {
                                    // å¼ºåˆ¶è§¦å‘é‡ç»˜
                                    img.style.opacity = '0.99';
                                    setTimeout(() => {
                                        img.style.opacity = '1';
                                    }, 50);
                                }
                                
                                Utils.updateDebugInfo('image_loaded', 'true');
                                resolve(img);
                            } else {
                                reject(new Error('å›¾ç‰‡æ— æ•ˆæˆ–æŸå'));
                            }
                        };
                        
                        img.onerror = function(e) {
                            loaded = true;
                            clearTimeout(timeout);
                            console.error('å›¾ç‰‡åŠ è½½é”™è¯¯:', e);
                            reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                        };
                        
                        // è·¨åŸŸè®¾ç½®
                        if (source.baseUrl.includes('http')) {
                            img.crossOrigin = 'anonymous';
                        }
                        
                        // ä¸‰æ˜Ÿè®¾å¤‡å¯èƒ½éœ€è¦referrerç­–ç•¥
                        if (this.deviceInfo.isSamsung) {
                            img.referrerPolicy = 'no-referrer';
                        }
                        
                        // å¼€å§‹åŠ è½½
                        img.src = imgUrl;
                        
                        // å¦‚æœå›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­
                        if (img.complete) {
                            img.onload();
                        }
                    });
                    
                } catch (error) {
                    console.warn(`ç¬¬ ${retryCount + 1} æ¬¡åŠ è½½å¤±è´¥:`, error.message);
                    
                    // æŒ‡æ•°é€€é¿é‡è¯•
                    const delay = 1000 * Math.pow(CONFIG.retryStrategy.backoffMultiplier, retryCount);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                    return this.loadImage(imageName, source, retryCount + 1);
                }
            }
        };
        
        // ==================== åº”ç”¨ç®¡ç†å™¨ ====================
        const AppManager = {
            deviceId: null,
            imageIndex: 0,
            
            // ç”Ÿæˆè®¾å¤‡ID
            generateDeviceId: function() {
                // å°è¯•å¤šç§æ–¹æ³•è·å–å”¯ä¸€æ ‡è¯†
                const keys = [
                    localStorage.getItem(CONFIG.storageKeys.deviceId),
                    sessionStorage.getItem(CONFIG.storageKeys.deviceId),
                    'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                ];
                
                for (const key of keys) {
                    if (key && key.length > 10) {
                        this.deviceId = key;
                        break;
                    }
                }
                
                if (!this.deviceId) {
                    this.deviceId = keys[2];
                }
                
                // å­˜å‚¨è®¾å¤‡ID
                try {
                    localStorage.setItem(CONFIG.storageKeys.deviceId, this.deviceId);
                    sessionStorage.setItem(CONFIG.storageKeys.deviceId, this.deviceId);
                } catch (e) {
                    // å­˜å‚¨å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨
                    console.warn('å­˜å‚¨å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨');
                }
                
                Utils.updateDebugInfo('device_id', this.deviceId.substring(0, 10) + '...');
                return this.deviceId;
            },
            
            // è·å–å›¾ç‰‡ç´¢å¼•
            getImageIndex: function(deviceId) {
                try {
                    const stored = localStorage.getItem(CONFIG.storageKeys.imageIndex);
                    if (stored !== null) {
                        const index = parseInt(stored, 10);
                        if (!isNaN(index) && index >= 0 && index < CONFIG.images.length) {
                            this.imageIndex = index;
                            return this.imageIndex;
                        }
                    }
                    
                    // åŸºäºè®¾å¤‡IDè®¡ç®—å›ºå®šç´¢å¼•
                    let hash = 0;
                    for (let i = 0; i < deviceId.length; i++) {
                        hash = ((hash << 5) - hash) + deviceId.charCodeAt(i);
                        hash = hash & 0x7FFFFFFF;
                    }
                    
                    this.imageIndex = hash % CONFIG.images.length;
                    localStorage.setItem(CONFIG.storageKeys.imageIndex, this.imageIndex.toString());
                    return this.imageIndex;
                    
                } catch (e) {
                    // å‡ºé”™æ—¶ä½¿ç”¨éšæœºç´¢å¼•
                    this.imageIndex = Math.floor(Math.random() * CONFIG.images.length);
                    return this.imageIndex;
                }
            },
            
            // åˆå§‹åŒ–åº”ç”¨
            initialize: async function() {
                try {
                    Utils.showLoading();
                    Utils.updateStatus('åº”ç”¨åˆå§‹åŒ–...');
                    
                    // 1. æ£€æµ‹è®¾å¤‡ä¿¡æ¯
                    const deviceInfo = DeviceInfo.detect();
                    Utils.updateDebugInfo('device', deviceInfo.os + ' ' + deviceInfo.browser);
                    Utils.updateDebugInfo('isSamsung', deviceInfo.isSamsung);
                    
                    // 2. è·å–è®¾å¤‡IDå’Œå›¾ç‰‡ç´¢å¼•
                    this.deviceId = this.generateDeviceId();
                    this.imageIndex = this.getImageIndex(this.deviceId);
                    const imageName = CONFIG.images[this.imageIndex];
                    
                    Utils.updateStatus(`å‡†å¤‡åŠ è½½: ${imageName}`);
                    Utils.updateDebugInfo('image', imageName);
                    
                    // 3. æŸ¥æ‰¾æœ€ä½³å›¾ç‰‡æº
                    const source = await NetworkManager.findBestSource();
                    if (!source) {
                        throw new Error('æ‰€æœ‰å›¾ç‰‡æºéƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    // 4. åŠ è½½å›¾ç‰‡
                    Utils.updateStatus('æ­£åœ¨åŠ è½½å›¾ç‰‡...');
                    const img = await NetworkManager.loadImage(imageName, source);
                    
                    // 5. æ˜¾ç¤ºå›¾ç‰‡
                    const imageElement = document.getElementById('image');
                    imageElement.src = img.src;
                    
                    // æ·»åŠ åŠ è½½å®Œæˆçš„å›è°ƒ
                    imageElement.onload = function() {
                        Utils.updateStatus('å›¾ç‰‡åŠ è½½å®Œæˆ');
                        setTimeout(() => {
                            Utils.showImage();
                            Utils.updateProgress(100);
                        }, 300);
                    };
                    
                    // å¦‚æœå›¾ç‰‡å·²ç»åŠ è½½å®Œæˆ
                    if (img.complete) {
                        Utils.updateStatus('å›¾ç‰‡åŠ è½½å®Œæˆ');
                        setTimeout(() => {
                            Utils.showImage();
                            Utils.updateProgress(100);
                        }, 300);
                    }
                    
                    // è®°å½•æˆåŠŸæ—¥å¿—
                    console.log('âœ… åº”ç”¨åˆå§‹åŒ–æˆåŠŸ');
                    console.log('ğŸ“± è®¾å¤‡:', deviceInfo.os, deviceInfo.browser);
                    console.log('ğŸ†” è®¾å¤‡ID:', this.deviceId);
                    console.log('ğŸ–¼ï¸  å›¾ç‰‡:', imageName);
                    console.log('ğŸŒ å›¾ç‰‡æº:', source.name);
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    await this.handleError(error);
                }
            },
            
            // é”™è¯¯å¤„ç†
            handleError: async function(error) {
                let title = 'åŠ è½½å¤±è´¥';
                let message = error.message || 'æœªçŸ¥é”™è¯¯';
                
                // ç½‘ç»œé”™è¯¯
                if (error.message.includes('ç½‘ç»œ') || 
                    error.message.includes('è¿æ¥') || 
                    error.message.includes('timeout') ||
                    error.message.includes('æº')) {
                    
                    title = 'ç½‘ç»œè¿æ¥é—®é¢˜';
                    message = `
                        <div style="text-align: left;">
                        <strong>æ£€æµ‹åˆ°ç½‘ç»œé—®é¢˜ï¼š</strong><br><br>
                        <strong>å¸¸è§åŸå› ï¼š</strong><br>
                        1. GitHubåœ¨ä¸­å›½è®¿é—®ä¸ç¨³å®š<br>
                        2. ä¼ä¸š/å­¦æ ¡å†…ç½‘é™åˆ¶<br>
                        3. DNSè§£æå¤±è´¥<br>
                        4. SSLè¯ä¹¦é—®é¢˜<br><br>
                        
                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                        1. å°è¯•ä½¿ç”¨å¤‡ç”¨è®¿é—®æ–¹å¼<br>
                        2. åˆ‡æ¢ç½‘ç»œï¼ˆWiFi/4G/5Gï¼‰<br>
                        3. å…³é—­VPNæˆ–ä»£ç†è½¯ä»¶<br>
                        4. é‡å¯æ‰‹æœºç½‘ç»œ<br><br>
                        
                        <em>æç¤ºï¼šä¸‰æ˜Ÿæ‰‹æœºè¯·å°è¯•å…³é—­"å®‰å…¨WiFi"æˆ–"éšç§æ¨¡å¼"</em>
                        </div>
                    `;
                }
                // å›¾ç‰‡åŠ è½½é”™è¯¯
                else if (error.message.includes('å›¾ç‰‡')) {
                    title = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                    message = `
                        <div style="text-align: left;">
                        <strong>å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š</strong><br><br>
                        1. å›¾ç‰‡å¯èƒ½å·²æŸå<br>
                        2. æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜<br>
                        3. å†…å­˜ä¸è¶³<br><br>
                        
                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                        1. å°è¯•é‡æ–°è¿æ¥<br>
                        2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜<br>
                        3. é‡å¯æµè§ˆå™¨
                        </div>
                    `;
                }
                
                Utils.showError(title, message);
            },
            
            // é‡è¯•è¿æ¥
            retry: function() {
                Utils.showLoading();
                Utils.updateStatus('é‡æ–°è¿æ¥ä¸­...');
                Utils.updateProgress(0);
                
                // æ¸…é™¤å­˜å‚¨çš„æºï¼Œå¼ºåˆ¶é‡æ–°æµ‹è¯•
                localStorage.removeItem(CONFIG.storageKeys.preferredSource);
                
                // å»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                setTimeout(() => {
                    this.initialize();
                }, 1500);
            },
            
            // æ˜¾ç¤ºå¤‡ç”¨é“¾æ¥
            showAlternativeLinks: function() {
                const links = `
                    <div style="text-align: left;">
                    <strong>å¤‡ç”¨è®¿é—®æ–¹å¼ï¼š</strong><br><br>
                    
                    <strong>æ¨èæ–¹å¼ï¼š</strong><br>
                    1. <a href="https://cfelix888.github.io/chunjie/" target="_blank" style="color: #007AFF; text-decoration: none;">
                       GitHub Pagesä¸»é“¾æ¥ â†—
                    </a><br><br>
                    
                    <strong>å¤‡é€‰æ–¹æ¡ˆï¼š</strong><br>
                    2. <a href="https://raw.githack.com/cfelix888/chunjie/main/index.html" target="_blank" style="color: #007AFF; text-decoration: none;">
                       RawGité“¾æ¥ â†—
                    </a><br>
                    3. <a href="http://htmlpreview.github.io/?https://github.com/cfelix888/chunjie/blob/main/index.html" target="_blank" style="color: #007AFF; text-decoration: none;">
                       GitHub HTMLé¢„è§ˆ â†—
                    </a><br><br>
                    
                    <strong>ç‰¹æ®Šæ–¹æ¡ˆï¼ˆå†…ç½‘å¯ç”¨ï¼‰ï¼š</strong><br>
                    4. <a href="https://cdn.jsdelivr.net/gh/cfelix888/chunjie/index.html" target="_blank" style="color: #007AFF; text-decoration: none;">
                       jsDelivrç›´æ¥é“¾æ¥ â†—
                    </a><br><br>
                    
                    <small style="color: #888;">
                    <strong>æ“ä½œæç¤ºï¼š</strong><br>
                    - é•¿æŒ‰é“¾æ¥é€‰æ‹©"åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€"<br>
                    - ä¸‰æ˜Ÿæ‰‹æœºè¯·ä½¿ç”¨Chromeæµè§ˆå™¨<br>
                    - å†…ç½‘ç¯å¢ƒå°è¯•å…³é—­é˜²ç«å¢™<br>
                    - å¦‚ä»æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œä»£ç†è®¾ç½®
                    </small>
                    </div>
                `;
                
                Utils.showError('å¤‡ç”¨è®¿é—®æ–¹å¼', links);
            }
        };
        
        // ==================== è®¾å¤‡å…¼å®¹æ€§ä¿®å¤ ====================
        const CompatibilityFix = {
            applyFixes: function() {
                const deviceInfo = DeviceInfo.detect();
                
                // é€šç”¨ä¿®å¤
                this.preventCommonIssues();
                
                // ä¸‰æ˜Ÿè®¾å¤‡ç‰¹æ®Šä¿®å¤
                if (deviceInfo.isSamsung) {
                    this.applySamsungFixes();
                }
                
                // iOSè®¾å¤‡ç‰¹æ®Šä¿®å¤
                if (deviceInfo.isIOS) {
                    this.applyIOSFixes();
                }
                
                // å¾®ä¿¡/QQå†…ç½®æµè§ˆå™¨ä¿®å¤
                if (deviceInfo.isWechat || deviceInfo.isQQ) {
                    this.applyWechatFixes();
                }
            },
            
            preventCommonIssues: function() {
                // ç¦æ­¢é»˜è®¤è¡Œä¸º
                document.addEventListener('touchmove', (e) => {
                    if (e.target.tagName !== 'BUTTON' && 
                        e.target.tagName !== 'A' && 
                        e.target.tagName !== 'INPUT') {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // ç¦æ­¢ç¼©æ”¾
                document.addEventListener('gesturestart', (e) => {
                    e.preventDefault();
                });
                
                // ç¦æ­¢æ–‡å­—é€‰æ‹©
                document.addEventListener('selectstart', (e) => {
                    e.preventDefault();
                });
                
                // ç¡®ä¿é¡µé¢ä½ç½®
                window.scrollTo(0, 0);
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
                
                // ä¿®å¤100vhé—®é¢˜
                this.fixViewportHeight();
                
                // ç›‘å¬çª—å£å˜åŒ–
                window.addEventListener('resize', () => {
                    this.fixViewportHeight();
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                });
            },
            
            applySamsungFixes: function() {
                console.log('åº”ç”¨ä¸‰æ˜Ÿè®¾å¤‡ä¿®å¤...');
                
                // ä¸‰æ˜Ÿæµè§ˆå™¨ç¼“å­˜é—®é¢˜
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        for (const registration of registrations) {
                            registration.unregister();
                        }
                    });
                }
                
                // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
                if (window.caches) {
                    caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => {
                            caches.delete(cacheName);
                        });
                    });
                }
                
                // ä¸‰æ˜Ÿè®¾å¤‡å›¾ç‰‡æ¸²æŸ“ä¼˜åŒ–
                const style = document.createElement('style');
                style.textContent = `
                    img {
                        image-rendering: -webkit-optimize-contrast;
                        image-rendering: crisp-edges;
                        backface-visibility: hidden;
                        transform: translateZ(0);
                    }
                `;
                document.head.appendChild(style);
            },
            
            applyIOSFixes: function() {
                console.log('åº”ç”¨iOSè®¾å¤‡ä¿®å¤...');
                
                // iOSå…¨å±æ¨¡å¼ä¿®å¤
                document.body.style.height = window.innerHeight + 'px';
                
                // iOSç‚¹å‡»å»¶è¿Ÿä¿®å¤
                if ('ontouchstart' in window) {
                    document.addEventListener('touchstart', function() {}, false);
                }
                
                // iOSæ©¡çš®ç­‹æ•ˆæœé™åˆ¶
                document.body.style.overscrollBehavior = 'none';
            },
            
            applyWechatFixes: function() {
                console.log('åº”ç”¨å¾®ä¿¡/QQæµè§ˆå™¨ä¿®å¤...');
                
                // å¾®ä¿¡æµè§ˆå™¨ç¼“å­˜é—®é¢˜
                const noCacheMeta = document.createElement('meta');
                noCacheMeta.httpEquiv = 'Pragma';
                noCacheMeta.content = 'no-cache';
                document.head.appendChild(noCacheMeta);
                
                // ç¦ç”¨å¾®ä¿¡åˆ†äº«èœå•
                document.addEventListener('WeixinJSBridgeReady', function() {
                    WeixinJSBridge.call('hideOptionMenu');
                });
            },
            
            fixViewportHeight: function() {
                // ä¿®å¤ç§»åŠ¨ç«¯100vhé—®é¢˜
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // åº”ç”¨ä¿®å¤
                const app = document.getElementById('app');
                if (app) {
                    app.style.height = window.innerHeight + 'px';
                }
            }
        };
        
        // ==================== ç½‘ç»œçŠ¶æ€ç›‘å¬ ====================
        const NetworkMonitor = {
            init: function() {
                // ç›‘å¬åœ¨çº¿/ç¦»çº¿çŠ¶æ€
                window.addEventListener('online', () => {
                    Utils.setOfflineIndicator(false);
                    Utils.updateDebugInfo('network', 'online');
                    
                    // å¦‚æœå½“å‰å¤„äºé”™è¯¯çŠ¶æ€ï¼Œè‡ªåŠ¨é‡è¯•
                    const errorPanel = document.getElementById('errorPanel');
                    if (errorPanel && errorPanel.style.display === 'block') {
                        setTimeout(() => {
                            AppManager.retry();
                        }, 1000);
                    }
                });
                
                window.addEventListener('offline', () => {
                    Utils.setOfflineIndicator(true);
                    Utils.updateDebugInfo('network', 'offline');
                    
                    // æ˜¾ç¤ºç¦»çº¿æç¤º
                    if (!document.getElementById('errorPanel').style.display === 'block') {
                        Utils.showError('ç½‘ç»œå·²æ–­å¼€', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                    }
                });
                
                // åˆå§‹åŒ–ç½‘ç»œçŠ¶æ€
                Utils.setOfflineIndicator(!navigator.onLine);
            }
        };
        
        // ==================== åˆå§‹åŒ–å…¥å£ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
            const deviceInfo = DeviceInfo.detect();
            console.log('è®¾å¤‡æ£€æµ‹:', deviceInfo);
            
            // åº”ç”¨å…¼å®¹æ€§ä¿®å¤
            CompatibilityFix.applyFixes();
            
            // åˆå§‹åŒ–ç½‘ç»œç›‘æ§
            NetworkMonitor.init();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('retryBtn').addEventListener('click', function() {
                AppManager.retry();
            });
            
            document.getElementById('linkBtn').addEventListener('click', function() {
                AppManager.showAlternativeLinks();
            });
            
            // é˜²æ­¢å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // å»¶è¿Ÿå¯åŠ¨åº”ç”¨
            setTimeout(function() {
                AppManager.initialize();
            }, 500);
        });
        
        // é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ
        window.addEventListener('load', function() {
            // ç¡®ä¿é¡µé¢ä½ç½®
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // éšè—åœ°å€æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
            setTimeout(function() {
                window.scrollTo(0, 0);
            }, 100);
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
                const imageContainer = document.getElementById('imageContainer');
                if (imageContainer && imageContainer.style.display === 'block') {
                    imageContainer.style.display = 'none';
                    setTimeout(function() {
                        imageContainer.style.display = 'block';
                    }, 50);
                }
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>蔚来可期</title>
    
    <!-- 极简meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    
    <style>
        /* 极简CSS - 减少阻塞 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100vw; height: 100vh; overflow: hidden; background: #000; }
        
        /* 加载动画 */
        .loading {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 图片容器 */
        .image-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            background: #000;
            display: none;
        }
        
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* 错误面板 */
        .error-panel {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 200;
        }
        
        .error-content {
            max-width: 400px;
            text-align: center;
        }
        
        .btn {
            margin: 10px;
            padding: 12px 24px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 200px;
        }
        
        .btn-alt {
            background: transparent;
            border: 1px solid #007AFF;
            color: #007AFF;
        }
    </style>
    
    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
</head>
<body>
    <!-- 加载界面 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="status">加载中...</div>
    </div>
    
    <!-- 图片容器 -->
    <div class="image-container" id="imageContainer">
        <img id="image" alt="蔚来可期" crossorigin="anonymous">
    </div>
    
    <!-- 错误面板 -->
    <div class="error-panel" id="errorPanel">
        <div class="error-content">
            <div style="font-size: 40px; margin-bottom: 15px;">⚠️</div>
            <div style="font-size: 20px; margin-bottom: 10px;" id="errorTitle">加载失败</div>
            <div style="font-size: 14px; color: #ccc; margin-bottom: 25px;" id="errorMsg">
                请检查网络连接后重试
            </div>
            <button class="btn" id="retryBtn">重试</button>
            <button class="btn btn-alt" id="altBtn">备用链接</button>
            <div style="margin-top: 25px; font-size: 12px; color: #666;">
                建议使用Chrome浏览器访问
            </div>
        </div>
    </div>

    <script>
        // ==================== 极速配置 ====================
        const CONFIG = {
            // 只使用最快最稳定的源
            imageSources: [
                // jsDelivr CDN（最快，中国可用）
                {
                    name: 'CDN',
                    baseUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/'
                }
            ],
            
            // 图片列表
            images: [
                "马年窗贴-02.jpg",
                "马年窗贴-03.jpg", 
                "马年窗贴-04.jpg",
                "马年窗贴-05.jpg",
                "马年窗贴-06.jpg",
                "马年窗贴-07.jpg",
                "马年窗贴-08.jpg",
                "马年窗贴-09.jpg",
                "马年窗贴-10.jpg",
                "马年窗贴-11.jpg"
            ]
        };
        
        // ==================== 极简核心 ====================
        class FastLoader {
            constructor() {
                this.statusEl = document.getElementById('status');
                this.loadingEl = document.getElementById('loading');
                this.imageContainer = document.getElementById('imageContainer');
                this.imageEl = document.getElementById('image');
                this.errorPanel = document.getElementById('errorPanel');
                this.errorTitle = document.getElementById('errorTitle');
                this.errorMsg = document.getElementById('errorMsg');
                
                // 绑定按钮
                document.getElementById('retryBtn').addEventListener('click', () => this.retry());
                document.getElementById('altBtn').addEventListener('click', () => this.showAltLinks());
            }
            
            updateStatus(text) {
                if (this.statusEl) {
                    this.statusEl.textContent = text;
                }
            }
            
            showLoading() {
                this.loadingEl.style.display = 'flex';
                this.imageContainer.style.display = 'none';
                this.errorPanel.style.display = 'none';
            }
            
            showImage() {
                this.loadingEl.style.display = 'none';
                this.imageContainer.style.display = 'block';
                this.errorPanel.style.display = 'none';
            }
            
            showError(title, message) {
                this.loadingEl.style.display = 'none';
                this.imageContainer.style.display = 'none';
                this.errorPanel.style.display = 'flex';
                
                if (this.errorTitle) this.errorTitle.textContent = title;
                if (this.errorMsg) this.errorMsg.innerHTML = message;
            }
            
            // 获取设备ID（简化版）
            getDeviceId() {
                let id = localStorage.getItem('fast_device_id');
                if (!id) {
                    id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                    localStorage.setItem('fast_device_id', id);
                }
                return id;
            }
            
            // 获取图片索引
            getImageIndex(deviceId) {
                // 使用简单哈希算法
                let hash = 0;
                for (let i = 0; i < deviceId.length; i++) {
                    hash = ((hash << 5) - hash) + deviceId.charCodeAt(i);
                    hash = hash & hash; // 转换为32位整数
                }
                return Math.abs(hash) % CONFIG.images.length;
            }
            
            // 直接加载图片（不测试源）
            async loadImageDirectly() {
                return new Promise((resolve, reject) => {
                    const deviceId = this.getDeviceId();
                    const imageIndex = this.getImageIndex(deviceId);
                    const imageName = CONFIG.images[imageIndex];
                    const source = CONFIG.imageSources[0]; // 直接使用第一个源
                    
                    this.updateStatus(`加载: ${imageName}`);
                    
                    const imgUrl = source.baseUrl + encodeURIComponent(imageName) + '?v=' + Date.now();
                    
                    console.log('开始加载:', imgUrl);
                    
                    const img = new Image();
                    let loaded = false;
                    
                    // 设置超时
                    const timeoutTimer = setTimeout(() => {
                        if (!loaded) {
                            img.onload = img.onerror = null;
                            reject(new Error('加载超时 (15秒)'));
                        }
                    }, 15000);
                    
                    // 成功回调
                    img.onload = () => {
                        loaded = true;
                        clearTimeout(timeoutTimer);
                        
                        if (img.complete && img.naturalWidth > 0) {
                            console.log('✅ 图片加载成功');
                            resolve({ img, imageName, source: source.name });
                        } else {
                            reject(new Error('图片不完整'));
                        }
                    };
                    
                    // 错误回调
                    img.onerror = (err) => {
                        loaded = true;
                        clearTimeout(timeoutTimer);
                        console.error('❌ 图片加载失败:', err);
                        reject(new Error('加载失败'));
                    };
                    
                    // 开始加载
                    img.crossOrigin = 'anonymous';
                    img.src = imgUrl;
                    
                    // 如果图片已经在缓存中
                    if (img.complete) {
                        img.onload();
                    }
                });
            }
            
            // 主加载流程
            async load() {
                try {
                    this.showLoading();
                    this.updateStatus('准备加载...');
                    
                    // 立即开始加载，不测试网络
                    const result = await this.loadImageDirectly();
                    
                    // 显示图片
                    this.imageEl.src = result.img.src;
                    this.updateStatus('加载完成!');
                    
                    // 延迟显示图片，确保渲染
                    setTimeout(() => {
                        this.showImage();
                    }, 300);
                    
                    console.log('✅ 加载完成:', result.imageName, '来自:', result.source);
                    
                } catch (error) {
                    console.error('加载失败:', error);
                    this.handleError(error);
                }
            }
            
            // 错误处理
            handleError(error) {
                let title = '加载失败';
                let message = '请检查网络连接';
                
                if (error.message.includes('超时')) {
                    title = '加载超时';
                    message = `
                        <div style="text-align: left; line-height: 1.6;">
                        <strong>可能的原因：</strong><br>
                        1. 网络连接较慢<br>
                        2. 服务器响应延迟<br>
                        3. 图片文件较大<br><br>
                        
                        <strong>建议：</strong><br>
                        1. 点击"重试"按钮<br>
                        2. 切换到4G/5G网络<br>
                        3. 使用"备用链接"访问
                        </div>
                    `;
                }
                
                this.showError(title, message);
            }
            
            // 重试
            retry() {
                this.showLoading();
                this.updateStatus('重新加载...');
                
                // 强制刷新缓存
                if ('caches' in window) {
                    caches.keys().then(keys => {
                        keys.forEach(key => caches.delete(key));
                    });
                }
                
                // 延迟加载
                setTimeout(() => {
                    this.load();
                }, 800);
            }
            
            // 显示备用链接
            showAltLinks() {
                const message = `
                    <div style="text-align: left; line-height: 1.6;">
                    <strong>备用访问方式：</strong><br><br>
                    
                    <strong>推荐（最快）：</strong><br>
                    <a href="https://cdn.jsdelivr.net/gh/cfelix888/chunjie/" 
                       style="color: #007AFF; text-decoration: none;"
                       onclick="event.preventDefault(); window.open(this.href, '_blank');">
                       https://cdn.jsdelivr.net/gh/cfelix888/chunjie/
                    </a><br><br>
                    
                    <strong>备用：</strong><br>
                    <a href="https://raw.githack.com/cfelix888/chunjie/main/index.html"
                       style="color: #007AFF; text-decoration: none;"
                       onclick="event.preventDefault(); window.open(this.href, '_blank');">
                       https://raw.githack.com/cfelix888/chunjie/main/index.html
                    </a><br><br>
                    
                    <strong>提示：</strong><br>
                    • 长按链接选择"在新标签页打开"<br>
                    • 建议使用Chrome浏览器<br>
                    • 关闭VPN和代理
                    </div>
                `;
                
                this.showError('备用链接', message);
            }
            
            // 初始化
            init() {
                // 立即开始加载
                setTimeout(() => {
                    this.load();
                }, 100);
            }
        }
        
        // ==================== 页面初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 禁止默认行为
            document.addEventListener('touchmove', (e) => {
                if (e.target.tagName !== 'BUTTON' && 
                    e.target.tagName !== 'A' && 
                    e.target.tagName !== 'INPUT') {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // 禁止缩放
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            
            // 确保页面位置
            window.scrollTo(0, 0);
            
            // 创建加载器并启动
            window.loader = new FastLoader();
            window.loader.init();
        });
        
        // 页面加载完成
        window.addEventListener('load', function() {
            window.scrollTo(0, 0);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>è”šæ¥å¯æœŸ-ä½ çš„æ–°å¹´buff112a</title>
    
    <!-- è‹¹æœå¿…é¡»çš„metaæ ‡ç­¾ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    
    <!-- é€šç”¨meta -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <!-- åœ¨ head ä¸­æ·»åŠ  -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval'">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        /* æç®€æ ·å¼ï¼Œç¡®ä¿å…¼å®¹æ€§ */
        * {
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
        }
        
        #app {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 100;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .error-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            width: 320px;
            border: 1px solid #333;
            display: none;
        }
        
        .retry-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            width: 100%;
        }
        
        .link-btn {
            background: transparent;
            color: #007AFF;
            border: 1px solid #007AFF;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
        }
        
        .network-tips {
            margin-top: 15px;
            font-size: 12px;
            color: #999;
            text-align: left;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>buffæ­£åœ¨èµ¶æ¥ä¸­...</div>
        </div>
        
        <img id="image" alt="è”šæ¥å¯æœŸé©¬å¹´çª—è´´">
        
        <div class="error-panel" id="errorPanel">
            <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸</div>
            <div style="font-size: 18px; margin-bottom: 15px;" id="errorTitle">ç½‘ç»œè¿æ¥å¤±è´¥</div>
            <div style="font-size: 14px; color: #ccc; margin-bottom: 20px;" id="errorMsg">
                æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®
            </div>
            <button class="retry-btn" onclick="retryConnection()">é‡è¯•è¿æ¥</button>
            <div style="margin-top: 15px;">
                <button class="link-btn" onclick="showAlternativeLinks()">å¤‡ç”¨è®¿é—®æ–¹å¼</button>
            </div>
            <div class="network-tips" id="networkTips">
                <strong>ç½‘ç»œé—®é¢˜å¯èƒ½åŸå› ï¼š</strong><br>
                1. GitHubè¢«ç½‘ç»œé™åˆ¶<br>
                2. SSLè¯ä¹¦é—®é¢˜<br>
                3. ç½‘ç»œè¿è¥å•†é™åˆ¶
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const CONFIG = {
            // å¤šæºå›¾ç‰‡è·¯å¾„ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
            imageSources: [
                // 1. ç›´æ¥GitHub Pagesï¼ˆä¸»æºï¼‰
                {
                    name: 'GitHubä¸»æº',
                    baseUrl: 'https://cfelix888.github.io/chunjie/images/',
                    testUrl: 'https://cfelix888.github.io/chunjie/images/é©¬å¹´çª—è´´-02.jpg'
                },
                // 2. jsDelivr CDNï¼ˆæ¨èï¼Œæ”¯æŒä¸­å›½è®¿é—®ï¼‰
                {
                    name: 'jsDelivr CDN',
                    baseUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/',
                    testUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/é©¬å¹´çª—è´´-02.jpg'
                },
                // 3. Raw GitHubï¼ˆå¤‡ç”¨ï¼‰
                {
                    name: 'GitHub Raw',
                    baseUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/',
                    testUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/é©¬å¹´çª—è´´-02.jpg'
                }
            ],
            
            // å›¾ç‰‡åˆ—è¡¨
            images: [
                "é©¬å¹´çª—è´´-02.jpg",
                "é©¬å¹´çª—è´´-03.jpg",
                "é©¬å¹´çª—è´´-04.jpg",
                "é©¬å¹´çª—è´´-05.jpg",
                "é©¬å¹´çª—è´´-06.jpg",
                "é©¬å¹´çª—è´´-07.jpg",
                "é©¬å¹´çª—è´´-08.jpg",
                "é©¬å¹´çª—è´´-09.jpg",
                "é©¬å¹´çª—è´´-10.jpg",
                "é©¬å¹´çª—è´´-11.jpg"
            ],
            
            // è®¾å¤‡å­˜å‚¨é”®å
            storageKeys: {
                deviceId: 'ne_device_id',
                imageIndex: 'ne_image_idx',
                preferredSource: 'ne_preferred_source'
            }
        };
        
        // ==================== å·¥å…·å‡½æ•° ====================
        
        function updateStatus(text) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = text;
            }
            console.log('çŠ¶æ€:', text);
        }
        
        function showError(title, message) {
            const loading = document.getElementById('loading');
            const errorPanel = document.getElementById('errorPanel');
            const errorTitle = document.getElementById('errorTitle');
            const errorMsg = document.getElementById('errorMsg');
            
            if (loading) loading.style.display = 'none';
            if (errorTitle) errorTitle.textContent = title;
            if (errorMsg) errorMsg.innerHTML = message;
            if (errorPanel) errorPanel.style.display = 'block';
        }
        
        function showLoading() {
            const loading = document.getElementById('loading');
            const errorPanel = document.getElementById('errorPanel');
            
            if (loading) loading.style.display = 'block';
            if (errorPanel) errorPanel.style.display = 'none';
        }
        
        // ==================== ç½‘ç»œæµ‹è¯• ====================
        
        async function testConnection(url) {
            return new Promise((resolve) => {
                const timeout = 8000; // 8ç§’è¶…æ—¶
                const startTime = Date.now();
                
                fetch(url, {
                    method: 'HEAD',
                    mode: 'no-cors', // ä½¿ç”¨no-corsç»•è¿‡CORSé™åˆ¶
                    cache: 'no-cache'
                })
                .then(() => {
                    const latency = Date.now() - startTime;
                    resolve({ success: true, latency });
                })
                .catch(() => {
                    // å°è¯•ä½¿ç”¨ImageåŠ è½½æµ‹è¯•ï¼ˆç»•è¿‡CORSï¼‰
                    const img = new Image();
                    const timer = setTimeout(() => {
                        resolve({ success: false, error: 'timeout' });
                    }, timeout);
                    
                    img.onload = () => {
                        clearTimeout(timer);
                        const latency = Date.now() - startTime;
                        resolve({ success: true, latency });
                    };
                    
                    img.onerror = () => {
                        clearTimeout(timer);
                        resolve({ success: false, error: 'image_error' });
                    };
                    
                    img.src = url + '?test=' + Date.now();
                });
            });
        }
        
        async function findBestSource() {
            updateStatus();
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„é¦–é€‰æº
            const preferred = localStorage.getItem(CONFIG.storageKeys.preferredSource);
            if (preferred) {
                const source = CONFIG.imageSources.find(s => s.name === preferred);
                if (source) {
                    updateStatus();
                    const result = await testConnection(source.testUrl);
                    if (result.success) {
                        updateStatus(`âœ… ä½¿ç”¨å­˜å‚¨çš„æº: ${source.name}`);
                        return source;
                    }
                }
            }
            
            // é€ä¸€æµ‹è¯•æ‰€æœ‰æº
            for (const source of CONFIG.imageSources) {
                updateStatus();
                const result = await testConnection(source.testUrl);
                
                if (result.success) {
                    updateStatus(`âœ… ${source.name} å¯ç”¨ (${result.latency}ms)`);
                    // å­˜å‚¨é¦–é€‰æº
                    localStorage.setItem(CONFIG.storageKeys.preferredSource, source.name);
                    return source;
                } else {
                    updateStatus(`âŒ ${source.name} ä¸å¯ç”¨`);
                }
            }
            
            return null;
        }
        
        // ==================== è®¾å¤‡è¯†åˆ« ====================
        
        function getDeviceId() {
            let deviceId = localStorage.getItem(CONFIG.storageKeys.deviceId);
            
            if (!deviceId) {
                // ç”Ÿæˆç®€å•è®¾å¤‡IDï¼ˆé¿å…ä½¿ç”¨å¯èƒ½è¢«æ‹¦æˆªçš„APIï¼‰
                deviceId = 'dev_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                try {
                    localStorage.setItem(CONFIG.storageKeys.deviceId, deviceId);
                } catch (e) {
                    // å¦‚æœlocalStorageå¤±è´¥ï¼Œä½¿ç”¨sessionStorage
                    sessionStorage.setItem(CONFIG.storageKeys.deviceId, deviceId);
                }
            }
            
            return deviceId;
        }
        
        function getImageIndex(deviceId) {
            const stored = localStorage.getItem(CONFIG.storageKeys.imageIndex);
            if (stored !== null) {
                const index = parseInt(stored);
                if (index >= 0 && index < CONFIG.images.length) {
                    return index;
                }
            }
            
            // è®¡ç®—å›ºå®šç´¢å¼•
            let hash = 0;
            for (let i = 0; i < deviceId.length; i++) {
                hash = ((hash << 5) - hash) + deviceId.charCodeAt(i);
                hash = hash & 0x7FFFFFFF;
            }
            
            const index = hash % CONFIG.images.length;
            localStorage.setItem(CONFIG.storageKeys.imageIndex, index.toString());
            return index;
        }
        
        // ==================== å›¾ç‰‡åŠ è½½ ====================
        
        async function loadImageWithRetry(imageName, source, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    updateStatus(`åŠ è½½buffä¸­...`);
                    
                    const imgUrl = source.baseUrl + encodeURIComponent(imageName) + 
                                 '?v=' + Date.now() + '&attempt=' + i;
                    
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        const timer = setTimeout(() => {
                            reject(new Error('åŠ è½½è¶…æ—¶'));
                        }, 10000);
                        
                        img.onload = () => {
                            clearTimeout(timer);
                            if (img.complete && img.naturalWidth > 0) {
                                resolve(img);
                            } else {
                                reject(new Error('å›¾ç‰‡æœªå®Œå…¨åŠ è½½'));
                            }
                        };
                        
                        img.onerror = () => {
                            clearTimeout(timer);
                            reject(new Error('åŠ è½½å¤±è´¥'));
                        };
                        
                        // è‹¹æœSafariå¯èƒ½éœ€è¦crossOrigin
                        if (navigator.userAgent.includes('Safari') && 
                            !navigator.userAgent.includes('Chrome')) {
                            img.crossOrigin = 'anonymous';
                        }
                        
                        img.src = imgUrl;
                        
                        // å¦‚æœå·²ç»åœ¨ç¼“å­˜ä¸­
                        if (img.complete) {
                            clearTimeout(timer);
                            resolve(img);
                        }
                    });
                    
                } catch (error) {
                    console.warn(`ç¬¬ ${i + 1} æ¬¡å°è¯•å¤±è´¥:`, error.message);
                    if (i === retries - 1) throw error;
                    // ç­‰å¾…1ç§’åé‡è¯•
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
        
        // ==================== ä¸»æµç¨‹ ====================
        
        async function initializeApp() {
            try {
                showLoading();
                updateStatus();
                
                // 1. è·å–è®¾å¤‡ä¿¡æ¯
                const deviceId = getDeviceId();
                const imageIndex = getImageIndex(deviceId);
                const imageName = CONFIG.images[imageIndex];
                
                updateStatus(`è®¾å¤‡å·²è¯†åˆ«ï¼Œå›¾ç‰‡: ${imageName}`);
                
                // 2. æŸ¥æ‰¾æœ€ä½³å›¾ç‰‡æº
                const source = await findBestSource();
                
                if (!source) {
                    throw new Error('æ‰€æœ‰å›¾ç‰‡æºéƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                
                updateStatus(`ä½¿ç”¨æº: ${source.name}`);
                
                // 3. åŠ è½½å›¾ç‰‡
                const img = await loadImageWithRetry(imageName, source);
                
                // 4. æ˜¾ç¤ºå›¾ç‰‡
                const imageElement = document.getElementById('image');
                imageElement.src = img.src;
                imageElement.style.display = 'block';
                
                // éšè—åŠ è½½æç¤º
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 500);
                
                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                console.log('ğŸ“± è®¾å¤‡ID:', deviceId);
                console.log('ğŸ–¼ï¸  å›¾ç‰‡:', imageName);
                console.log('ğŸŒ å›¾ç‰‡æº:', source.name);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                
                let errorTitle = 'åŠ è½½å¤±è´¥';
                let errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å»ºè®®
                if (error.message.includes('ç½‘ç»œ') || error.message.includes('è¿æ¥')) {
                    errorTitle = 'ç½‘ç»œè¿æ¥é—®é¢˜';
                    errorMessage = `
                        <div style="text-align: left; line-height: 1.6;">
                        <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
                        1. GitHubåœ¨ä¸­å›½è®¿é—®ä¸ç¨³å®š<br>
                        2. SSLè¯ä¹¦éªŒè¯å¤±è´¥<br>
                        3. ç½‘ç»œè¿è¥å•†é™åˆ¶<br><br>
                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                        1. å°è¯•ä½¿ç”¨å¤‡ç”¨è®¿é—®æ–¹å¼<br>
                        2. åˆ‡æ¢WiFi/4Gç½‘ç»œ<br>
                        3. ç¨åé‡è¯•
                        </div>
                    `;
                }
                
                showError(errorTitle, errorMessage);
            }
        }
        
        // ==================== ç”¨æˆ·æ“ä½œ ====================
        
        function retryConnection() {
            showLoading();
            updateStatus('é‡æ–°è¿æ¥ä¸­...');
            
            // æ¸…é™¤å­˜å‚¨çš„æºï¼Œå¼ºåˆ¶é‡æ–°æµ‹è¯•
            localStorage.removeItem(CONFIG.storageKeys.preferredSource);
            
            setTimeout(initializeApp, 500);
        }
        
        function showAlternativeLinks() {
            const links = `
                <div style="text-align: left; margin-top: 15px; font-size: 14px;">
                <strong>å¤‡ç”¨è®¿é—®æ–¹å¼ï¼š</strong><br><br>
                1. <a href="https://cfelix888.github.io/chunjie/" style="color: #007AFF;">GitHub Pagesä¸»é“¾æ¥</a><br>
                2. <a href="http://htmlpreview.github.io/?https://github.com/cfelix888/chunjie/blob/main/index.html" style="color: #007AFF;">GitHub HTMLé¢„è§ˆ</a><br>
                3. <a href="https://raw.githack.com/cfelix888/chunjie/main/index.html" style="color: #007AFF;">RawGité“¾æ¥</a><br><br>
                <small style="color: #888;">å¦‚æœä»¥ä¸Šé“¾æ¥éƒ½ä¸å¯ç”¨ï¼Œå»ºè®®ï¼š<br>
                - ä½¿ç”¨Chromeæµè§ˆå™¨<br>
                - å…³é—­VPNæˆ–ä»£ç†<br>
                - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</small>
                </div>
            `;
            
            showError('å¤‡ç”¨è®¿é—®æ–¹å¼', links);
        }
        
        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        
        // æ£€æµ‹è‹¹æœè®¾å¤‡å¹¶åº”ç”¨ç‰¹æ®Šä¿®å¤
        function applyAppleFixes() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            if (isIOS || isSafari) {
                console.log('æ£€æµ‹åˆ°è‹¹æœè®¾å¤‡...');
                
                // ä¿®å¤iOSå…¨å±é—®é¢˜
                document.body.style.height = window.innerHeight + 'px';
                
                // ä¿®å¤é”®ç›˜å¼¹å‡ºæ—¶é¡µé¢ç§»åŠ¨
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                    }, 100);
                });
                
                // ä¿®å¤Safariç¼“å­˜é—®é¢˜
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => {
                            caches.delete(cacheName);
                        });
                    });
                }
            }
        }
        
        // é˜²æ­¢å„ç§æµè§ˆå™¨é—®é¢˜
        function preventBrowserIssues() {
            // ç¦æ­¢æ»šåŠ¨
            document.addEventListener('touchmove', (e) => {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // ç¦æ­¢ç¼©æ”¾
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });
            
            // ç¡®ä¿é¡µé¢åœ¨é¡¶éƒ¨
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // é˜²æ­¢ç¦»å¼€é¡µé¢
            window.addEventListener('beforeunload', (e) => {
                // æç¤ºç”¨æˆ·
                e.preventDefault();
                e.returnValue = 'ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿå›¾ç‰‡å¯èƒ½æœªä¿å­˜';
            });
        }
        
        // ä¸»å…¥å£
        window.addEventListener('DOMContentLoaded', () => {
            applyAppleFixes();
            preventBrowserIssues();
            
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(() => {
                initializeApp();
            }, 300);
        });
        
        // ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
        window.addEventListener('load', () => {
            window.scrollTo(0, 0);
        });
        
        // å¯¼å‡ºå‡½æ•°ä¾›æŒ‰é’®ä½¿ç”¨
        window.retryConnection = retryConnection;
        window.showAlternativeLinks = showAlternativeLinks;
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>è”šæ¥å¯æœŸ - ä¸‰æ˜Ÿä¼˜åŒ–ç‰ˆ</title>
    
    <!-- ä¸‰æ˜Ÿå¿…é¡»çš„metaæ ‡ç­¾ -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no, email=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ä¸‰æ˜Ÿæµè§ˆå™¨ä¸“ç”¨ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="è”šæ¥å¯æœŸ">
    <meta name="theme-color" content="#000000">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- ç¼“å­˜æ§åˆ¶ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        /* ä¸‰æ˜Ÿè®¾å¤‡ä¼˜åŒ–æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        html, body {
            width: 100vw;
            height: 100vh;
            height: -webkit-fill-available;
            height: fill-available;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            font-family: 
                -apple-system, 
                BlinkMacSystemFont, 
                "Segoe UI", 
                Roboto, 
                "Helvetica Neue", 
                Arial, 
                "Noto Sans", 
                sans-serif;
        }
        
        /* ä¸‰æ˜ŸSafariæµè§ˆå™¨ç‰¹æ®Šä¿®å¤ */
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
        }
        
        #app {
            width: 100vw;
            height: 100vh;
            height: -webkit-fill-available;
            position: relative;
            overflow: hidden;
            background: #000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ffffff;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 30px 40px;
            border-radius: 20px;
            min-width: 250px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .status-text {
            font-size: 14px;
            color: #aaa;
            min-height: 20px;
            word-break: break-all;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin: 20px 0 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #00C6FF);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .image-container {
            width: 100%;
            height: 100%;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            background: #000;
        }
        
        #image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -webkit-user-drag: none;
        }
        
        .error-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 35px 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            border: 1px solid #333;
            display: none;
            z-index: 2000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
        }
        
        .error-icon {
            font-size: 50px;
            margin-bottom: 20px;
            display: block;
            color: #FF9500;
        }
        
        .error-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .error-message {
            font-size: 15px;
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.6;
            text-align: left;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
            text-decoration: none;
            text-align: center;
            outline: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .retry-btn {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        
        .retry-btn:active {
            box-shadow: 0 3px 10px rgba(0, 122, 255, 0.4);
        }
        
        .link-btn {
            background: transparent;
            color: #007AFF;
            border: 2px solid #007AFF;
        }
        
        .link-btn:active {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .network-tips {
            margin-top: 25px;
            padding: 18px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            font-size: 13px;
            color: #999;
            text-align: left;
            line-height: 1.7;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .network-tips strong {
            color: #fff;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border-radius: 6px;
            z-index: 10000;
            display: none;
            border: 1px solid rgba(0,255,0,0.2);
            max-height: 100px;
            overflow-y: auto;
        }
        
        .offline-indicator {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #FF3B30;
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: rgba(255,255,255,0.3);
            font-size: 11px;
            z-index: 1000;
        }
        
        /* ä¸‰æ˜Ÿä½ç«¯è®¾å¤‡ä¼˜åŒ– */
        @media screen and (max-width: 360px) {
            .loading {
                padding: 25px 30px;
                min-width: 220px;
            }
            
            .spinner {
                width: 40px;
                height: 40px;
            }
            
            .error-panel {
                width: 320px;
                padding: 30px 25px;
            }
            
            .btn {
                padding: 14px 18px;
                font-size: 16px;
            }
        }
    </style>
    
    <!-- é¢„è¿æ¥åˆ°å…³é”®èµ„æº -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://github.com">
    <link rel="dns-prefetch" href="https://raw.githubusercontent.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://github.com">
</head>
<body>
    <!-- ç¦»çº¿æŒ‡ç¤ºå™¨ -->
    <div class="offline-indicator" id="offlineIndicator">âš ï¸ ç¦»çº¿</div>
    
    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <div class="debug-info" id="debugInfo"></div>
    
    <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
    <div class="version-info">v3.0 - ä¸‰æ˜Ÿä¼˜åŒ–ç‰ˆ</div>
    
    <div id="app">
        <!-- åŠ è½½ç•Œé¢ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">æ­£åœ¨è¿æ¥...</div>
            <div class="status-text" id="status">æ£€æµ‹è®¾å¤‡ä¸­...</div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <!-- å›¾ç‰‡å®¹å™¨ -->
        <div class="image-container" id="imageContainer">
            <img id="image" alt="è”šæ¥å¯æœŸé©¬å¹´çª—è´´" crossorigin="anonymous" decoding="async">
        </div>
        
        <!-- é”™è¯¯é¢æ¿ -->
        <div class="error-panel" id="errorPanel">
            <span class="error-icon">âš ï¸</span>
            <div class="error-title" id="errorTitle">è¿æ¥å¤±è´¥</div>
            <div class="error-message" id="errorMsg">
                æ— æ³•åŠ è½½å†…å®¹ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
            </div>
            
            <button class="btn retry-btn" id="retryBtn">é‡æ–°è¿æ¥</button>
            <button class="btn link-btn" id="linkBtn">è§£å†³æ–¹æ¡ˆ</button>
            
            <div class="network-tips">
                <strong>ä¸‰æ˜Ÿæ‰‹æœºå¸¸è§é—®é¢˜ï¼š</strong>
                1. æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼ˆè¯·ä½¿ç”¨Chromeï¼‰<br>
                2. ç½‘ç»œä»£ç†è®¾ç½®é”™è¯¯<br>
                3. è¯·å…³é—­"å®‰å…¨WiFi"åŠŸèƒ½<br>
                4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œæ•°æ®
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const CONFIG = {
            // å›¾ç‰‡æºï¼ˆé’ˆå¯¹GitHub Pagesä¼˜åŒ–ï¼‰
            imageSources: [
                // ä¸»æºï¼šjsDelivr CDNï¼ˆå¯¹ä¸­å›½ç½‘ç»œæœ€å‹å¥½ï¼‰
                {
                    name: 'jsDelivr CDN',
                    baseUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/',
                    testUrl: 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/é©¬å¹´çª—è´´-02.jpg',
                    priority: 1
                },
                // å¤‡ç”¨ï¼šGitHub Pages
                {
                    name: 'GitHub Pages',
                    baseUrl: 'https://cfelix888.github.io/chunjie/images/',
                    testUrl: 'https://cfelix888.github.io/chunjie/images/é©¬å¹´çª—è´´-02.jpg',
                    priority: 2
                },
                // ç´§æ€¥å¤‡ç”¨ï¼šGitHub Raw
                {
                    name: 'GitHub Raw',
                    baseUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/',
                    testUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/é©¬å¹´çª—è´´-02.jpg',
                    priority: 3
                },
                // æç«¯å¤‡ç”¨ï¼šä½¿ç”¨IPåœ°å€
                {
                    name: 'IPç›´è¿',
                    baseUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/',
                    testUrl: 'https://raw.githubusercontent.com/cfelix888/chunjie/main/images/é©¬å¹´çª—è´´-02.jpg',
                    priority: 4
                }
            ],
            
            // å›¾ç‰‡åˆ—è¡¨
            images: [
                "é©¬å¹´çª—è´´-02.jpg",
                "é©¬å¹´çª—è´´-03.jpg",
                "é©¬å¹´çª—è´´-04.jpg",
                "é©¬å¹´çª—è´´-05.jpg",
                "é©¬å¹´çª—è´´-06.jpg",
                "é©¬å¹´çª—è´´-07.jpg",
                "é©¬å¹´çª—è´´-08.jpg",
                "é©¬å¹´çª—è´´-09.jpg",
                "é©¬å¹´çª—è´´-10.jpg",
                "é©¬å¹´çª—è´´-11.jpg"
            ],
            
            // å­˜å‚¨é”®å
            storageKeys: {
                deviceId: 'samsung_device_v3',
                imageIndex: 'samsung_image_v3',
                preferredSource: 'samsung_source_v3',
                lastError: 'samsung_error_v3'
            },
            
            // è¶…æ—¶è®¾ç½®ï¼ˆä¸‰æ˜Ÿè®¾å¤‡éœ€è¦æ›´é•¿ï¼‰
            timeouts: {
                connectionTest: 10000,    // 10ç§’
                imageLoad: 20000,         // 20ç§’
                retryDelay: 3000          // 3ç§’
            },
            
            // é‡è¯•ç­–ç•¥
            retry: {
                maxAttempts: 5,
                backoffBase: 1500
            }
        };

        // ==================== è®¾å¤‡æ£€æµ‹ ====================
        class DeviceDetector {
            constructor() {
                this.info = this.detect();
                this.isSamsung = this.info.isSamsung;
                this.isChina = this.info.isChina;
            }
            
            detect() {
                const ua = navigator.userAgent.toLowerCase();
                const isSamsung = /samsung/i.test(ua) || /sm-[a-z][0-9]{3}/i.test(ua);
                const isChina = /zh-cn/i.test(navigator.language) || 
                               /china/i.test(navigator.language) ||
                               /cn_/i.test(navigator.language);
                
                return {
                    isSamsung,
                    isChina,
                    isIOS: /iphone|ipad|ipod/.test(ua),
                    isAndroid: /android/.test(ua),
                    isWechat: /micromessenger/.test(ua),
                    browser: this.getBrowser(ua),
                    model: this.getModel(ua),
                    network: navigator.connection ? navigator.connection.effectiveType : 'unknown'
                };
            }
            
            getBrowser(ua) {
                if (/samsungbrowser/.test(ua)) return 'Samsung Browser';
                if (/chrome/.test(ua) && !/edg/.test(ua)) return 'Chrome';
                if (/firefox/.test(ua)) return 'Firefox';
                if (/safari/.test(ua) && !/chrome/.test(ua)) return 'Safari';
                if (/edge/.test(ua)) return 'Edge';
                return 'Unknown';
            }
            
            getModel(ua) {
                const match = ua.match(/sm-[a-z]([0-9]{3})/i);
                return match ? `Galaxy S${match[1]}` : 'Unknown';
            }
            
            log() {
                console.log('ğŸ“± è®¾å¤‡ä¿¡æ¯:', this.info);
                this.updateDebug('device', `${this.info.browser} - ${this.info.model}`);
                this.updateDebug('network', this.info.network);
                this.updateDebug('region', this.info.isChina ? 'ä¸­å›½' : 'å›½é™…');
            }
            
            updateDebug(key, value) {
                const debug = document.getElementById('debugInfo');
                if (debug) {
                    const lines = debug.innerHTML.split('<br>').filter(l => !l.startsWith(key + ':'));
                    lines.push(`${key}: ${value}`);
                    debug.innerHTML = lines.slice(-5).join('<br>');
                }
            }
        }

        // ==================== çŠ¶æ€ç®¡ç†å™¨ ====================
        class StateManager {
            constructor() {
                this.statusEl = document.getElementById('status');
                this.progressEl = document.getElementById('progressBar');
                this.progressContainer = document.getElementById('progressContainer');
            }
            
            update(text, progress = null) {
                if (this.statusEl) {
                    this.statusEl.textContent = text;
                }
                console.log('çŠ¶æ€:', text);
                
                if (progress !== null && this.progressEl) {
                    this.progressEl.style.width = progress + '%';
                    this.progressContainer.style.display = 'block';
                } else if (this.progressContainer) {
                    this.progressContainer.style.display = 'none';
                }
            }
            
            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('errorPanel').style.display = 'none';
                document.getElementById('imageContainer').style.display = 'none';
            }
            
            showError(title, message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorPanel').style.display = 'block';
                document.getElementById('imageContainer').style.display = 'none';
                
                document.getElementById('errorTitle').textContent = title;
                document.getElementById('errorMsg').innerHTML = message;
            }
            
            showImage() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorPanel').style.display = 'none';
                document.getElementById('imageContainer').style.display = 'block';
            }
            
            setOffline(offline) {
                document.getElementById('offlineIndicator').style.display = offline ? 'block' : 'none';
            }
        }

        // ==================== ç½‘ç»œç®¡ç†å™¨ ====================
        class NetworkManager {
            constructor() {
                this.device = new DeviceDetector();
                this.state = new StateManager();
                this.currentSource = null;
                this.lastTestTime = 0;
            }
            
            // æµ‹è¯•è¿æ¥ï¼ˆä¸‰æ˜Ÿä¼˜åŒ–ç‰ˆï¼‰
            async testConnection(url) {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    const timeout = CONFIG.timeouts.connectionTest;
                    
                    // æ–¹æ³•1ï¼šä½¿ç”¨XMLHttpRequestï¼ˆä¸‰æ˜Ÿæµè§ˆå™¨å…¼å®¹æ€§å¥½ï¼‰
                    const xhr = new XMLHttpRequest();
                    xhr.timeout = timeout;
                    
                    const timer = setTimeout(() => {
                        xhr.abort();
                        resolve({ success: false, error: 'timeout', latency: Date.now() - startTime });
                    }, timeout + 1000);
                    
                    xhr.onload = function() {
                        clearTimeout(timer);
                        const latency = Date.now() - startTime;
                        resolve({ 
                            success: xhr.status >= 200 && xhr.status < 300, 
                            status: xhr.status,
                            latency 
                        });
                    };
                    
                    xhr.onerror = xhr.ontimeout = function() {
                        clearTimeout(timer);
                        // æ–¹æ³•2ï¼šä½¿ç”¨Imageå¯¹è±¡ï¼ˆå¤‡ç”¨ï¼‰
                        NetworkManager.testWithImage(url, startTime, resolve);
                    };
                    
                    // æ·»åŠ éšæœºå‚æ•°é¿å…ç¼“å­˜
                    const uniqueUrl = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now() + Math.random();
                    xhr.open('GET', uniqueUrl, true);
                    
                    // ä¸‰æ˜Ÿæµè§ˆå™¨å¯èƒ½éœ€è¦ç‰¹æ®Šheader
                    if (this.device.isSamsung) {
                        xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
                        xhr.setRequestHeader('Pragma', 'no-cache');
                    }
                    
                    xhr.send();
                });
            }
            
            static testWithImage(url, startTime, resolve) {
                const img = new Image();
                const timeout = 8000;
                const timer = setTimeout(() => {
                    img.onload = img.onerror = null;
                    resolve({ success: false, error: 'image_timeout', latency: Date.now() - startTime });
                }, timeout);
                
                img.onload = function() {
                    clearTimeout(timer);
                    resolve({ success: true, latency: Date.now() - startTime });
                };
                
                img.onerror = function() {
                    clearTimeout(timer);
                    resolve({ success: false, error: 'image_error', latency: Date.now() - startTime });
                };
                
                // ä¸‰æ˜Ÿè®¾å¤‡éœ€è¦crossOrigin
                img.crossOrigin = 'anonymous';
                img.src = url + '?test=' + Date.now();
            }
            
            // æŸ¥æ‰¾æœ€ä½³æº
            async findBestSource() {
                this.state.update('æµ‹è¯•ç½‘ç»œè¿æ¥...', 10);
                
                // å¦‚æœæœ‰å­˜å‚¨çš„é¦–é€‰æºï¼Œå…ˆæµ‹è¯•
                const storedSource = localStorage.getItem(CONFIG.storageKeys.preferredSource);
                if (storedSource && Date.now() - this.lastTestTime < 300000) { // 5åˆ†é’Ÿå†…
                    const source = CONFIG.imageSources.find(s => s.name === storedSource);
                    if (source) {
                        this.state.update(`æµ‹è¯• ${source.name}...`, 30);
                        const result = await this.testConnection(source.testUrl);
                        if (result.success) {
                            this.state.update(`âœ… ${source.name} å¯ç”¨`, 50);
                            this.currentSource = source;
                            return source;
                        }
                    }
                }
                
                // å¹¶è¡Œæµ‹è¯•æ‰€æœ‰æº
                this.state.update('å¹¶è¡Œæµ‹è¯•æ‰€æœ‰æº...', 20);
                const tests = CONFIG.imageSources.map(async (source) => {
                    this.state.update(`æµ‹è¯• ${source.name}...`, 20 + source.priority * 10);
                    try {
                        const result = await this.testConnection(source.testUrl);
                        return { source, result };
                    } catch (e) {
                        return { source, result: { success: false, error: e.message } };
                    }
                });
                
                const results = await Promise.allSettled(tests);
                this.state.update('åˆ†ææµ‹è¯•ç»“æœ...', 70);
                
                // æ‰¾å‡ºå¯ç”¨çš„æº
                const available = [];
                for (const r of results) {
                    if (r.status === 'fulfilled') {
                        const { source, result } = r.value;
                        if (result.success) {
                            available.push({ source, latency: result.latency || 9999 });
                            console.log(`âœ… ${source.name}: ${result.latency}ms`);
                        } else {
                            console.log(`âŒ ${source.name}: ${result.error}`);
                        }
                    }
                }
                
                if (available.length > 0) {
                    // é€‰æ‹©æœ€å¿«æˆ–æœ€é€‚åˆä¸‰æ˜Ÿçš„æº
                    available.sort((a, b) => {
                        // ä¸‰æ˜Ÿè®¾å¤‡ä¼˜å…ˆä½¿ç”¨jsDelivr
                        if (this.device.isSamsung) {
                            if (a.source.name === 'jsDelivr CDN') return -1;
                            if (b.source.name === 'jsDelivr CDN') return 1;
                        }
                        return a.latency - b.latency;
                    });
                    
                    const best = available[0].source;
                    this.state.update(`ä½¿ç”¨ ${best.name}`, 80);
                    
                    // å­˜å‚¨é€‰æ‹©
                    localStorage.setItem(CONFIG.storageKeys.preferredSource, best.name);
                    this.lastTestTime = Date.now();
                    this.currentSource = best;
                    
                    return best;
                }
                
                return null;
            }
            
            // åŠ è½½å›¾ç‰‡
            async loadImage(imageName, source, attempt = 1) {
                if (attempt > CONFIG.retry.maxAttempts) {
                    throw new Error(`åŠ è½½å¤±è´¥ï¼Œå·²é‡è¯• ${CONFIG.retry.maxAttempts} æ¬¡`);
                }
                
                this.state.update(`åŠ è½½å›¾ç‰‡ (${attempt}/${CONFIG.retry.maxAttempts})...`, 30 + attempt * 10);
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const url = source.baseUrl + encodeURIComponent(imageName) + 
                               '?v=' + Date.now() + '&att=' + attempt + 
                               '&dev=' + (this.device.isSamsung ? 'samsung' : 'other');
                    
                    const timeout = setTimeout(() => {
                        img.onload = img.onerror = null;
                        reject(new Error('åŠ è½½è¶…æ—¶'));
                    }, CONFIG.timeouts.imageLoad);
                    
                    img.onload = () => {
                        clearTimeout(timeout);
                        if (img.complete && img.naturalWidth > 0) {
                            // ä¸‰æ˜Ÿè®¾å¤‡å›¾ç‰‡æ¸²æŸ“ä¼˜åŒ–
                            if (this.device.isSamsung) {
                                img.style.imageRendering = 'crisp-edges';
                                img.style.backfaceVisibility = 'hidden';
                                img.style.transform = 'translateZ(0)';
                            }
                            resolve(img);
                        } else {
                            reject(new Error('å›¾ç‰‡ä¸å®Œæ•´'));
                        }
                    };
                    
                    img.onerror = (e) => {
                        clearTimeout(timeout);
                        console.error('å›¾ç‰‡åŠ è½½é”™è¯¯:', e);
                        reject(new Error('åŠ è½½å¤±è´¥'));
                    };
                    
                    // ä¸‰æ˜Ÿè®¾å¤‡éœ€è¦ç‰¹æ®Šè®¾ç½®
                    if (this.device.isSamsung) {
                        img.crossOrigin = 'anonymous';
                        img.referrerPolicy = 'no-referrer';
                        img.decoding = 'async';
                    }
                    
                    img.src = url;
                    
                    // å¦‚æœå·²ç»åœ¨ç¼“å­˜ä¸­
                    if (img.complete) {
                        img.onload();
                    }
                }).catch(async (error) => {
                    console.warn(`ç¬¬ ${attempt} æ¬¡å°è¯•å¤±è´¥:`, error.message);
                    
                    // æŒ‡æ•°é€€é¿
                    const delay = CONFIG.retry.backoffBase * Math.pow(1.5, attempt - 1);
                    await new Promise(r => setTimeout(r, delay));
                    
                    return this.loadImage(imageName, source, attempt + 1);
                });
            }
        }

        // ==================== åº”ç”¨æ ¸å¿ƒ ====================
        class AppCore {
            constructor() {
                this.network = new NetworkManager();
                this.state = new StateManager();
                this.device = this.network.device;
                this.deviceId = null;
                this.imageIndex = 0;
            }
            
            // ç”Ÿæˆè®¾å¤‡ID
            getDeviceId() {
                try {
                    let id = localStorage.getItem(CONFIG.storageKeys.deviceId);
                    if (!id) {
                        // ç”Ÿæˆå”¯ä¸€ID
                        id = 'samsung_' + Date.now() + '_' + 
                             Math.random().toString(36).substr(2, 9) + '_' +
                             (this.device.isSamsung ? 'sm' : 'ot');
                        localStorage.setItem(CONFIG.storageKeys.deviceId, id);
                    }
                    this.deviceId = id;
                    return id;
                } catch (e) {
                    // å¦‚æœlocalStorageå¤±è´¥
                    this.deviceId = 'temp_' + Date.now();
                    return this.deviceId;
                }
            }
            
            // è·å–å›¾ç‰‡ç´¢å¼•
            getImageIndex(deviceId) {
                try {
                    const stored = localStorage.getItem(CONFIG.storageKeys.imageIndex);
                    if (stored !== null) {
                        const idx = parseInt(stored, 10);
                        if (!isNaN(idx) && idx >= 0 && idx < CONFIG.images.length) {
                            this.imageIndex = idx;
                            return idx;
                        }
                    }
                    
                    // åŸºäºè®¾å¤‡IDè®¡ç®—
                    let hash = 0;
                    for (let i = 0; i < deviceId.length; i++) {
                        hash = ((hash << 5) - hash) + deviceId.charCodeAt(i);
                        hash = hash & 0x7FFFFFFF;
                    }
                    
                    this.imageIndex = hash % CONFIG.images.length;
                    localStorage.setItem(CONFIG.storageKeys.imageIndex, this.imageIndex.toString());
                    return this.imageIndex;
                } catch (e) {
                    this.imageIndex = Math.floor(Math.random() * CONFIG.images.length);
                    return this.imageIndex;
                }
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            async initialize() {
                try {
                    this.state.showLoading();
                    this.device.log();
                    
                    // 1. è®¾å¤‡ä¿¡æ¯
                    this.state.update('åˆå§‹åŒ–è®¾å¤‡...', 5);
                    const deviceId = this.getDeviceId();
                    const imageIndex = this.getImageIndex(deviceId);
                    const imageName = CONFIG.images[imageIndex];
                    
                    this.state.update(`è®¾å¤‡: ${this.device.info.model}`, 10);
                    this.state.update(`å›¾ç‰‡: ${imageName}`, 15);
                    
                    // 2. ç½‘ç»œæµ‹è¯•
                    const source = await this.network.findBestSource();
                    if (!source) {
                        throw new Error('æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                    }
                    
                    this.state.update(`ä½¿ç”¨: ${source.name}`, 50);
                    
                    // 3. åŠ è½½å›¾ç‰‡
                    const img = await this.network.loadImage(imageName, source);
                    
                    // 4. æ˜¾ç¤º
                    const imgEl = document.getElementById('image');
                    imgEl.src = img.src;
                    imgEl.onload = () => {
                        this.state.update('åŠ è½½å®Œæˆ!', 100);
                        setTimeout(() => {
                            this.state.showImage();
                            console.log('âœ… æˆåŠŸåŠ è½½:', imageName);
                            console.log('ğŸŒ æ¥æº:', source.name);
                        }, 500);
                    };
                    
                    // å¦‚æœå·²ç»åŠ è½½å®Œæˆ
                    if (img.complete) {
                        this.state.update('åŠ è½½å®Œæˆ!', 100);
                        setTimeout(() => {
                            this.state.showImage();
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    await this.handleError(error);
                }
            }
            
            // é”™è¯¯å¤„ç†
            async handleError(error) {
                let title = 'åŠ è½½å¤±è´¥';
                let message = error.message;
                
                // ç½‘ç»œé”™è¯¯
                if (error.message.includes('ç½‘ç»œ') || 
                    error.message.includes('è¿æ¥') || 
                    error.message.includes('æœåŠ¡å™¨') ||
                    error.message.includes('timeout')) {
                    
                    title = 'ç½‘ç»œé—®é¢˜';
                    message = `
                        <div style="line-height: 1.7;">
                        <strong>ä¸‰æ˜Ÿæ‰‹æœºå¸¸è§ç½‘ç»œé—®é¢˜ï¼š</strong><br><br>
                        1. <strong>æµè§ˆå™¨é™åˆ¶ï¼š</strong>ä¸‰æ˜Ÿæµè§ˆå™¨è¾ƒä¸¥æ ¼<br>
                        &nbsp;&nbsp;ğŸ‘‰ å»ºè®®ä½¿ç”¨ <span style="color:#007AFF;">Chromeæµè§ˆå™¨</span><br><br>
                        
                        2. <strong>ç½‘ç»œä»£ç†ï¼š</strong>è¯·å…³é—­VPN/ä»£ç†<br>
                        &nbsp;&nbsp;ğŸ‘‰ è®¾ç½® â†’ è¿æ¥ â†’ æ›´å¤šè¿æ¥è®¾ç½® â†’ ç§äººDNS â†’ å…³é—­<br><br>
                        
                        3. <strong>å®‰å…¨è®¾ç½®ï¼š</strong>å…³é—­å®‰å…¨åŠŸèƒ½<br>
                        &nbsp;&nbsp;ğŸ‘‰ è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ å®‰å…¨WiFi â†’ å…³é—­<br><br>
                        
                        4. <strong>æ¸…é™¤ç¼“å­˜ï¼š</strong><br>
                        &nbsp;&nbsp;ğŸ‘‰ æµè§ˆå™¨è®¾ç½® â†’ éšç§ â†’ æ¸…é™¤æ•°æ®<br>
                        </div>
                    `;
                }
                // GitHubè®¿é—®é—®é¢˜
                else if (error.message.includes('GitHub')) {
                    title = 'GitHubè®¿é—®é™åˆ¶';
                    message = `
                        <div style="line-height: 1.7;">
                        <strong>ä¸­å›½ç”¨æˆ·æ— æ³•è®¿é—®GitHubçš„è§£å†³æ–¹æ¡ˆï¼š</strong><br><br>
                        1. <strong>ä½¿ç”¨é•œåƒç«™ï¼š</strong><br>
                        &nbsp;&nbsp;<a href="https://cdn.jsdelivr.net/gh/cfelix888/chunjie/index.html" style="color:#007AFF;">ç‚¹å‡»è¿™é‡Œä½¿ç”¨jsDelivré•œåƒ</a><br><br>
                        
                        2. <strong>å¤‡ç”¨é“¾æ¥ï¼š</strong><br>
                        &nbsp;&nbsp;<a href="https://raw.githack.com/cfelix888/chunjie/main/index.html" style="color:#007AFF;">RawGitå¤‡ç”¨é“¾æ¥</a><br><br>
                        
                        3. <strong>æµè§ˆå™¨æ¨èï¼š</strong><br>
                        &nbsp;&nbsp;âœ… Chromeæµè§ˆå™¨<br>
                        &nbsp;&nbsp;âŒ é¿å…ä½¿ç”¨ä¸‰æ˜Ÿè‡ªå¸¦æµè§ˆå™¨<br><br>
                        
                        <small style="color:#888;">GitHubåœ¨ä¸­å›½éƒ¨åˆ†åœ°åŒºè®¿é—®ä¸ç¨³å®šï¼Œè¿™æ˜¯ç½‘ç»œè¿è¥å•†çš„é—®é¢˜</small>
                        </div>
                    `;
                }
                
                this.state.showError(title, message);
                
                // è®°å½•é”™è¯¯
                try {
                    localStorage.setItem(CONFIG.storageKeys.lastError, 
                        JSON.stringify({
                            time: new Date().toISOString(),
                            error: error.message,
                            device: this.device.info
                        })
                    );
                } catch (e) {}
            }
            
            // é‡è¯•
            retry() {
                this.state.showLoading();
                this.state.update('é‡æ–°è¿æ¥ä¸­...', 0);
                
                // æ¸…é™¤ç¼“å­˜
                localStorage.removeItem(CONFIG.storageKeys.preferredSource);
                
                setTimeout(() => {
                    this.initialize();
                }, CONFIG.timeouts.retryDelay);
            }
            
            // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
            showSolutions() {
                const message = `
                    <div style="line-height: 1.7;">
                    <strong>ä¸‰æ˜Ÿæ‰‹æœºè§£å†³æ–¹æ¡ˆï¼š</strong><br><br>
                    
                    <strong>æ–¹æ¡ˆä¸€ï¼šæ›´æ¢æµè§ˆå™¨ï¼ˆæ¨èï¼‰</strong><br>
                    1. å®‰è£… <span style="color:#007AFF;">Google Chrome</span><br>
                    2. åœ¨Chromeä¸­è®¿é—®ï¼š<br>
                    &nbsp;&nbsp;<a href="https://cdn.jsdelivr.net/gh/cfelix888/chunjie/" style="color:#007AFF;">https://cdn.jsdelivr.net/gh/cfelix888/chunjie/</a><br><br>
                    
                    <strong>æ–¹æ¡ˆäºŒï¼šç½‘ç»œè®¾ç½®</strong><br>
                    1. å…³é—­æ‰€æœ‰VPN/ä»£ç†<br>
                    2. åˆ‡æ¢åˆ°4G/5Gç½‘ç»œ<br>
                    3. é‡å¯æ‰‹æœºç½‘ç»œ<br><br>
                    
                    <strong>æ–¹æ¡ˆä¸‰ï¼šä¸‰æ˜Ÿè®¾ç½®</strong><br>
                    1. è®¾ç½® â†’ åº”ç”¨ç¨‹åº â†’ ä¸‰æ˜Ÿæµè§ˆå™¨ â†’ å­˜å‚¨ â†’ æ¸…é™¤æ•°æ®<br>
                    2. è®¾ç½® â†’ è¿æ¥ â†’ æ›´å¤šè¿æ¥è®¾ç½® â†’ ç§äººDNS â†’ å…³é—­<br>
                    3. è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ å®‰å…¨WiFi â†’ å…³é—­<br><br>
                    
                    <strong>å¤‡ç”¨è®¿é—®åœ°å€ï¼š</strong><br>
                    â€¢ <a href="https://cdn.jsdelivr.net/gh/cfelix888/chunjie/" style="color:#007AFF;">jsDelivré•œåƒç«™</a><br>
                    â€¢ <a href="https://raw.githack.com/cfelix888/chunjie/main/index.html" style="color:#007AFF;">RawGitå¤‡ç”¨ç«™</a><br>
                    </div>
                `;
                
                this.state.showError('è§£å†³æ–¹æ¡ˆ', message);
            }
        }

        // ==================== å…¼å®¹æ€§ä¿®å¤ ====================
        class CompatibilityFix {
            static apply() {
                const device = new DeviceDetector();
                
                // é€šç”¨ä¿®å¤
                this.preventIssues();
                
                // ä¸‰æ˜Ÿè®¾å¤‡ç‰¹æ®Šä¿®å¤
                if (device.isSamsung) {
                    this.fixSamsung();
                }
                
                // ä¸­å›½ç½‘ç»œç¯å¢ƒä¿®å¤
                if (device.isChina) {
                    this.fixChinaNetwork();
                }
            }
            
            static preventIssues() {
                // ç¦æ­¢æ»šåŠ¨
                document.addEventListener('touchmove', (e) => {
                    if (e.target.tagName !== 'BUTTON' && 
                        e.target.tagName !== 'A' && 
                        e.target.tagName !== 'INPUT' &&
                        e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // ç¦æ­¢ç¼©æ”¾
                document.addEventListener('gesturestart', (e) => e.preventDefault());
                
                // ç¡®ä¿é¡µé¢åœ¨é¡¶éƒ¨
                window.scrollTo(0, 0);
                window.addEventListener('scroll', () => window.scrollTo(0, 0));
                
                // ä¿®å¤100vhé—®é¢˜
                this.fixViewportHeight();
                window.addEventListener('resize', this.fixViewportHeight);
            }
            
            static fixSamsung() {
                console.log('åº”ç”¨ä¸‰æ˜Ÿè®¾å¤‡ä¿®å¤');
                
                // ä¸‰æ˜Ÿæµè§ˆå™¨ç¼“å­˜é—®é¢˜
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        regs.forEach(reg => reg.unregister());
                    });
                }
                
                // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(keys => {
                        keys.forEach(key => caches.delete(key));
                    });
                }
                
                // ä¸‰æ˜Ÿå›¾ç‰‡æ¸²æŸ“ä¼˜åŒ–
                const style = document.createElement('style');
                style.textContent = `
                    img {
                        image-rendering: -webkit-optimize-contrast !important;
                        image-rendering: crisp-edges !important;
                        -webkit-backface-visibility: hidden !important;
                        backface-visibility: hidden !important;
                    }
                `;
                document.head.appendChild(style);
            }
            
            static fixChinaNetwork() {
                // é’ˆå¯¹ä¸­å›½ç½‘ç»œçš„ä¼˜åŒ–
                console.log('åº”ç”¨ä¸­å›½ç½‘ç»œä¼˜åŒ–');
                
                // é¢„åŠ è½½å…³é”®èµ„æº
                const prefetch = document.createElement('link');
                prefetch.rel = 'prefetch';
                prefetch.href = 'https://cdn.jsdelivr.net/gh/cfelix888/chunjie/images/é©¬å¹´çª—è´´-02.jpg';
                document.head.appendChild(prefetch);
            }
            
            static fixViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                const app = document.getElementById('app');
                if (app) {
                    app.style.height = window.innerHeight + 'px';
                }
            }
        }

        // ==================== ç½‘ç»œç›‘æ§ ====================
        class NetworkMonitor {
            static init() {
                // ç›‘å¬ç½‘ç»œçŠ¶æ€
                window.addEventListener('online', () => {
                    new StateManager().setOffline(false);
                    document.getElementById('debugInfo').innerHTML += '<br>ç½‘ç»œ: å·²è¿æ¥';
                    
                    // å¦‚æœå½“å‰æ˜¯é”™è¯¯çŠ¶æ€ï¼Œè‡ªåŠ¨é‡è¯•
                    if (document.getElementById('errorPanel').style.display === 'block') {
                        setTimeout(() => {
                            window.app?.retry();
                        }, 2000);
                    }
                });
                
                window.addEventListener('offline', () => {
                    new StateManager().setOffline(true);
                    document.getElementById('debugInfo').innerHTML += '<br>ç½‘ç»œ: å·²æ–­å¼€';
                });
                
                // åˆå§‹çŠ¶æ€
                new StateManager().setOffline(!navigator.onLine);
            }
        }

        // ==================== ä¸»å…¥å£ ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å¯åŠ¨ä¸‰æ˜Ÿä¼˜åŒ–ç‰ˆ...');
            
            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼ˆé•¿æŒ‰é¡µé¢3ç§’æ˜¾ç¤ºï¼‰
            let debugTapCount = 0;
            let lastTapTime = 0;
            document.addEventListener('touchstart', (e) => {
                const now = Date.now();
                if (now - lastTapTime < 300) {
                    debugTapCount++;
                    if (debugTapCount >= 5) {
                        document.getElementById('debugInfo').style.display = 
                            document.getElementById('debugInfo').style.display === 'none' ? 'block' : 'none';
                        debugTapCount = 0;
                    }
                } else {
                    debugTapCount = 1;
                }
                lastTapTime = now;
            });
            
            // åº”ç”¨å…¼å®¹æ€§ä¿®å¤
            CompatibilityFix.apply();
            
            // åˆå§‹åŒ–ç½‘ç»œç›‘æ§
            NetworkMonitor.init();
            
            // åˆ›å»ºåº”ç”¨å®ä¾‹
            window.app = new AppCore();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('retryBtn').addEventListener('click', () => window.app.retry());
            document.getElementById('linkBtn').addEventListener('click', () => window.app.showSolutions());
            
            // é˜²æ­¢å³é”®èœå•
            document.addEventListener('contextmenu', (e) => e.preventDefault());
            
            // å»¶è¿Ÿå¯åŠ¨
            setTimeout(() => {
                window.app.initialize();
            }, 800);
        });
        
        // é¡µé¢å®Œå…¨åŠ è½½
        window.addEventListener('load', function() {
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // ä¿®å¤ä¸‰æ˜Ÿæµè§ˆå™¨çš„åœ°å€æ é—®é¢˜
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 300);
            
            // ä¸‰æ˜Ÿè®¾å¤‡åŠ è½½ä¼˜åŒ–
            if (navigator.userAgent.includes('Samsung')) {
                setTimeout(() => {
                    if (document.readyState === 'complete') {
                        document.getElementById('loading').style.opacity = '1';
                    }
                }, 100);
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && window.app) {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œåˆ·æ–°å›¾ç‰‡æ˜¾ç¤º
                const imgContainer = document.getElementById('imageContainer');
                if (imgContainer && imgContainer.style.display === 'block') {
                    imgContainer.style.display = 'none';
                    setTimeout(() => {
                        imgContainer.style.display = 'block';
                    }, 50);
                }
            }
        });
    </script>
</body>
</html>
